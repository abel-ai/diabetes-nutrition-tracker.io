<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Diabetes Nutrition Tracker - Combined Report Download</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f8ff;
    min-height: 100vh;
    padding-top: 2rem;
    padding-bottom: 2rem;
  }
  h1 {
    color: #0d6efd;
    font-weight: 700;
    text-align: center;
    margin-bottom: 1.5rem;
  }
  h2.section-title {
    color: #0d6efd;
    font-weight: 700;
    margin-bottom: 1.5rem;
    text-align: center;
  }
  td:first-child, td.timestamp-cell {
    text-align: left !important;
  }
  .btn-remove {
    font-weight: 700;
    color: #dc3545;
    border: none;
    background: transparent;
    font-size: 1.3rem;
    cursor: pointer;
  }
  .btn-remove:hover {
    color: #a71d2a;
  }
  .table-responsive {
    max-height: 350px;
    overflow-y: auto;
  }
  #food-suggestions {
  position: absolute;
  z-index: 1050;
  max-height: 150px;
  overflow-y: auto;
  width: 100%;
  border: 1px solid #ced4da;
  border-top: none;
  background: rgba(0, 0, 0, 0.85);
  color: white;
  border-bottom-left-radius: 0.375rem;
  border-bottom-right-radius: 0.375rem;
  display: none;
}
#food-suggestions .list-group-item {
  cursor: pointer;
  background: transparent;
  color: white;
  border: none;
}
#food-suggestions .list-group-item:hover {
  background-color: #0d6efd;
  color: white;
}
  .position-relative {
    position: relative;
}
</style>
</head>
<body>

<div class="container">
  <h1>Diabetes Nutrition Tracker</h1>

  <div class="row g-4">
    <section class="col-lg-5 col-md-6 bg-white p-4 rounded shadow-sm" aria-label="Meal Entry">
      <h2 class="section-title">Add Meal</h2>

      <form id="meal-form" novalidate autocomplete="off">
        <div class="mb-3 position-relative">
          <label for="food-input" class="form-label fw-semibold text-primary">Food Item:</label>
          <input type="text" id="food-input" class="form-control" placeholder="Start typing food..." autocomplete="off" required />
          <div id="food-suggestions" class="list-group"></div>
          <div class="invalid-feedback">Please select or type a food item.</div>
        </div>

        <div class="mb-3">
          <label for="weight-input" class="form-label fw-semibold text-primary">Weight (grams):</label>
          <input type="number" id="weight-input" min="1" value="100" class="form-control" required />
          <div class="invalid-feedback">Please enter a valid weight greater than zero.</div>
        </div>

        <div class="mb-3">
          <label for="datetime-input" class="form-label fw-semibold text-primary">Date & Time:</label>
          <input type="datetime-local" id="datetime-input" class="form-control" required />
          <div class="invalid-feedback">Please enter date and time.</div>
        </div>

        <button type="submit" id="add-meal-btn" class="btn btn-primary w-100 fw-bold">Add to Meals</button>
      </form>

      <h3 class="mt-4 text-center text-primary fw-bold">Meals Added</h3>
      <div class="table-responsive mt-3">
        <table id="meals-table" class="table table-striped table-bordered align-middle" aria-live="polite" style="min-width: 900px;">
          <thead class="table-light">
            <tr>
              <th>Timestamp</th>
              <th>Food</th>
              <th>Weight (g)</th>
              <th>Protein</th>
              <th>Potassium</th>
              <th>Carbs</th>
              <th>Fiber</th>
              <th>Sugar</th>
              <th>Calories</th>
              <th>Phosphorus</th>
              <th>Remove</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="col-lg-7 col-md-6 bg-white p-4 rounded shadow-sm" aria-label="Monthly Summary & Download">
      <h2 class="section-title">Monthly Summary & Download</h2>

      <div class="mb-3">
        <label for="month-select" class="form-label fw-semibold text-primary">Select Month:</label>
        <input type="month" id="month-select" class="form-control" />
      </div>

      <div class="d-flex flex-column flex-sm-row gap-3">
        <button id="load-month-btn" class="btn btn-info text-white fw-bold flex-fill">Load Summary</button>
        <button id="download-combined-csv-btn" class="btn btn-success fw-bold flex-fill">Download CSV</button>
        <button id="download-combined-xlsx-btn" class="btn btn-warning fw-bold flex-fill">Download Excel (.xlsx)</button>
      </div>

      <h3 class="mt-4 text-center text-primary fw-bold">Summary</h3>
      <div class="table-responsive mt-3" style="max-width:400px; margin-left:auto; margin-right:auto;">
        <table id="monthly-summary-table" class="table table-bordered text-center">
          <thead class="table-light">
            <tr><th>Nutrient</th><th>Amount</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="mt-4">
        <canvas id="nutrient-chart" height="150"></canvas>
      </div>
    </section>
  </div>
</div>

<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055;">
  <div id="mealToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        Meal added successfully!
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/shim.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const foodData = [
      { "name" : "Compliments  Plain Greek Yogurt ", "nutrientsPer100g": { "Protein": 9.7143, "Potassium": 171.4286, "Carbs": 2.2857, "Fiber": 0, "Sugar": 2.2857, "Calories": 45.7143, "Phosphorus": 0 } },
      { "name": "Greek Yogurt Plain", "nutrientsPer100g": { "Protein": 9.7143, "Potassium": 142.8571, "Carbs": 4.5714, "Fiber": 0, "Sugar": 2.8571, "Calories": 57.1429, "Phosphorus": 136 } },
      { "name": "Greek Yogurt Vanilla", "nutrientsPer100g": { "Protein": 9.7143, "Potassium": 128.5714, "Carbs": 10.2857, "Fiber": 0, "Sugar": 9.1429, "Calories": 80, "Phosphorus": 101 } },
      { "name": "Greek Low fat Yogurt", "nutrientsPer100g": { "Protein": 10, "Potassium": 141, "Carbs": 3.95, "Fiber": 0, "Sugar": 3.75, "Calories": 73, "Phosphorus": 126 } },
      { "name": "Astro Yogurt", "nutrientsPer100g": { "Protein": 0, "Potassium": 171.4286, "Carbs": 6, "Fiber": 0, "Sugar": 11.4286, "Calories": 0, "Phosphorus": 0 } },
  ];

  const foodInput = document.getElementById('food-input');
  const suggestionsContainer = document.getElementById('food-suggestions');
  const weightInput = document.getElementById('weight-input');
  const datetimeInput = document.getElementById('datetime-input');
  const mealForm = document.getElementById('meal-form');
  const mealsTableBody = document.querySelector('#meals-table tbody');
  const monthSelect = document.getElementById('month-select');
  const loadMonthBtn = document.getElementById('load-month-btn');
  const downloadCombinedCsvBtn = document.getElementById('download-combined-csv-btn');
  const downloadCombinedXlsxBtn = document.getElementById('download-combined-xlsx-btn');
  const monthlySummaryTableBody = document.querySelector('#monthly-summary-table tbody');
  const toastElement = document.getElementById('mealToast');
  const toast = new bootstrap.Toast(toastElement);

  let nutrientChart;

  function setCurrentDatetimeLocal() {
    const now = new Date();
    const offsetMs = now.getTimezoneOffset()*60*1000;
    const localISOTime = new Date(now - offsetMs).toISOString().slice(0,16);
    datetimeInput.value = localISOTime;
  }
  setCurrentDatetimeLocal();

  function findFoodByName(name) {
    const lower = name.trim().toLowerCase();
    return foodData.find(f => f.name.trim().toLowerCase() === lower);
  }

  function loadAllMeals() {
    const allMeals = JSON.parse(localStorage.getItem('diabetesMealsAll') || '[]');
    return allMeals;
  }

  function saveAllMeals(meals) {
    localStorage.setItem('diabetesMealsAll', JSON.stringify(meals));
  }

  function calculateNutrients(food, weight) {
    const scale = weight / 100;
    const nutrients = {};
    for (const [key, val] of Object.entries(food.nutrientsPer100g)) {
      let numVal = Number(val);
      if (isNaN(numVal)) numVal = 0;
      nutrients[key] = numVal * scale;
    }
    return nutrients;
  }

  function renderMealsTable() {
    const meals = loadAllMeals();
    meals.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
    mealsTableBody.innerHTML = '';
    if (meals.length === 0) {
      mealsTableBody.innerHTML = '<tr><td colspan="11" class="text-center">No meals added yet.</td></tr>';
      return;
    }
    meals.forEach((meal, i) => {
      const dt = new Date(meal.timestamp);
      const formattedDate = dt.toLocaleString();
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="timestamp-cell" title="${meal.timestamp}">${formattedDate}</td>
        <td>${meal.foodName}</td>
        <td>${meal.weight}</td>
        <td>${meal.nutrients.Protein.toFixed(2)}</td>
        <td>${meal.nutrients.Potassium.toFixed(2)}</td>
        <td>${meal.nutrients.Carbs.toFixed(2)}</td>
        <td>${meal.nutrients.Fiber.toFixed(2)}</td>
        <td>${meal.nutrients.Sugar.toFixed(2)}</td>
        <td>${meal.nutrients.Calories.toFixed(2)}</td>
        <td>${meal.nutrients.Phosphorus.toFixed(2)}</td>
        <td><button type="button" data-index="${i}" class="btn-remove" aria-label="Remove meal">✕</button></td>
      `;
      mealsTableBody.appendChild(tr);
    });
  }

  function aggregateMonthlyData(yearMonth) {
    const meals = loadAllMeals();
    const totals = {
      Protein: 0, Potassium: 0, Carbs: 0, Fiber: 0,
      Sugar: 0, Calories: 0, Phosphorus: 0
    };
    meals.forEach(meal => {
      if (meal.timestamp.startsWith(yearMonth)) {
        for (const nut in totals) {
          totals[nut] += meal.nutrients[nut] || 0;
        }
      }
    });
    return totals;
  }

  function renderMonthlySummary(yearMonth) {
    monthlySummaryTableBody.innerHTML = '';
    if (!yearMonth) {
      monthlySummaryTableBody.innerHTML = '<tr><td colspan="2" class="text-center">Select a month to view summary</td></tr>';
      if (nutrientChart) {
        nutrientChart.destroy();
        nutrientChart = null;
      }
      return;
    }
    const totals = aggregateMonthlyData(yearMonth);
    for (const [nutrient, value] of Object.entries(totals)) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${nutrient}</td><td>${value.toFixed(2)}</td>`;
      monthlySummaryTableBody.appendChild(tr);
    }
    renderNutrientChart(totals);
  }

  function renderNutrientChart(totals) {
    const ctx = document.getElementById('nutrient-chart').getContext('2d');
    const labels = Object.keys(totals);
    const data = labels.map(key => totals[key].toFixed(2));

    if (nutrientChart) {
      nutrientChart.data.labels = labels;
      nutrientChart.data.datasets[0].data = data;
      nutrientChart.update();
    } else {
      nutrientChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Nutrient Intake',
            data,
            backgroundColor: 'rgba(13, 110, 253, 0.7)',
            borderRadius: 4,
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }
  }

  foodInput.addEventListener('input', () => {
    const val = foodInput.value.trim().toLowerCase();
    suggestionsContainer.innerHTML = '';
    if (val.length < 1) {
      suggestionsContainer.style.display = 'none';
      return;
    }
    const matches = foodData.filter(food => food.name.toLowerCase().includes(val));
    if (matches.length === 0) {
      suggestionsContainer.style.display = 'none';
      return;
    }
    matches.forEach(food => {
      const item = document.createElement('a');
      item.className = 'list-group-item list-group-item-action';
      item.textContent = food.name;
      item.href = '#';
      item.addEventListener('click', e => {
        e.preventDefault();
        foodInput.value = food.name;
        suggestionsContainer.style.display = 'none';
      });
      suggestionsContainer.appendChild(item);
    });
    suggestionsContainer.style.display = 'block';
  });

  document.addEventListener('click', e => {
    if (!foodInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
      suggestionsContainer.style.display = 'none';
    }
  });

  mealForm.addEventListener('submit', e => {
    e.preventDefault();
    mealForm.classList.add('was-validated');

    if (!mealForm.checkValidity()) {
      return;
    }

    const foodName = foodInput.value.trim();
    const weight = parseFloat(weightInput.value);
    const datetimeVal = datetimeInput.value;

    const food = findFoodByName(foodName);
    if (!food) {
      alert('Food not found in database.');
      foodInput.focus();
      return;
    }

    const nutrients = calculateNutrients(food, weight);
    const meals = loadAllMeals();
    meals.push({foodName, weight, nutrients, timestamp: datetimeVal});
    saveAllMeals(meals);
    renderMealsTable();

    mealForm.reset();
    setCurrentDatetimeLocal();
    mealForm.classList.remove('was-validated');

    toast.show();
  });

  mealsTableBody.addEventListener('click', e => {
    if (!e.target.classList.contains('btn-remove')) return;
    const index = parseInt(e.target.dataset.index);
    if (isNaN(index)) return;
    const meals = loadAllMeals();
    meals.splice(index, 1);
    saveAllMeals(meals);
    renderMealsTable();
  });

  loadMonthBtn.addEventListener('click', () => {
    const monthVal = monthSelect.value;
    if (!monthVal) {
      alert('Please select a month.');
      return;
    }
    renderMonthlySummary(monthVal);
  });

  function downloadCombinedCSV(yearMonth) {
    const meals = loadAllMeals().filter(m => m.timestamp.startsWith(yearMonth));
    const summaryTotals = aggregateMonthlyData(yearMonth);

    let csvContent = 'Nutrient,Amount\n';
    for (const [nutrient, val] of Object.entries(summaryTotals)) {
      csvContent += `${nutrient},${val.toFixed(2)}\n`;
    }
    csvContent += '\n\n';
    csvContent += 'Timestamp,Food,Weight (g),Protein,Potassium,Carbs,Fiber,Sugar,Calories,Phosphorus\n';
    meals.forEach(m => {
      const dtStr = new Date(m.timestamp).toLocaleString();
      csvContent += `"${dtStr}","${m.foodName}",${m.weight},${m.nutrients.Protein.toFixed(2)},${m.nutrients.Potassium.toFixed(2)},${m.nutrients.Carbs.toFixed(2)},${m.nutrients.Fiber.toFixed(2)},${m.nutrients.Sugar.toFixed(2)},${m.nutrients.Calories.toFixed(2)},${m.nutrients.Phosphorus.toFixed(2)}\n`;
    });

    const blob = new Blob([csvContent], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `Nutrition_Report_${yearMonth}.csv`; a.click();
    URL.revokeObjectURL(url);
  }

  downloadCombinedCsvBtn.addEventListener('click', () => {
    const monthVal = monthSelect.value;
    if (!monthVal) {
      alert('Select month first.');
      return;
    }
    downloadCombinedCSV(monthVal);
  });

  function downloadCombinedXLSX(yearMonth) {
    const meals = loadAllMeals().filter(m => m.timestamp.startsWith(yearMonth));
    const summaryTotals = aggregateMonthlyData(yearMonth);

    const summaryRows = [['Nutrient', 'Amount']];
    for (const [nutrient, val] of Object.entries(summaryTotals)) {
      summaryRows.push([nutrient, parseFloat(val.toFixed(2))]);
    }

    const mealsRows = [['Timestamp','Food','Weight (g)','Protein','Potassium','Carbs','Fiber','Sugar','Calories','Phosphorus']];
    meals.forEach(m => {
      const dtStr = new Date(m.timestamp).toLocaleString();
      mealsRows.push([
        dtStr,
        m.foodName,
        m.weight,
        parseFloat(m.nutrients.Protein.toFixed(2)),
        parseFloat(m.nutrients.Potassium.toFixed(2)),
        parseFloat(m.nutrients.Carbs.toFixed(2)),
        parseFloat(m.nutrients.Fiber.toFixed(2)),
        parseFloat(m.nutrients.Sugar.toFixed(2)),
        parseFloat(m.nutrients.Calories.toFixed(2)),
        parseFloat(m.nutrients.Phosphorus.toFixed(2))
      ]);
    });

    const wb = XLSX.utils.book_new();
    const wsSummary = XLSX.utils.aoa_to_sheet(summaryRows);
    const wsMeals = XLSX.utils.aoa_to_sheet(mealsRows);

    XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');
    XLSX.utils.book_append_sheet(wb, wsMeals, 'Meals');

    XLSX.writeFile(wb, `Nutrition_Report_${yearMonth}.xlsx`);
  }

  downloadCombinedXlsxBtn.addEventListener('click', () => {
    const monthVal = monthSelect.value;
    if (!monthVal) {
      alert('Select month first.');
      return;
    }
    downloadCombinedXLSX(monthVal);
  });

  renderMealsTable();
  (function setDefaultMonth() {
    const now = new Date();
    const monthStr = now.toISOString().slice(0,7);
    monthSelect.value = monthStr;
  })();
</script>

</body>
</html>
